{% macro section_header(title, count, icon_class) %}
<div class="d-flex flex-items-center mb-2 mt-4">
  <h3 class="f4 text-normal">{{ title }}</h3>
  <span class="Counter ml-2">{{ count }}</span>
</div>
{% endmacro %}

{% macro unstick_form(item, org) %}
<details class="details-reset details-overlay d-inline-block">
  <summary class="btn btn-sm btn-danger" aria-haspopup="true">Unstick</summary>
  <div class="SelectMenu">
    <div class="SelectMenu-modal">
      <header class="SelectMenu-header">
        <h3 class="SelectMenu-title">Move to stage</h3>
      </header>
      <div class="SelectMenu-list">
        {% for target in ['agentPlanning', 'agentImplementing', 'agentPR', 'agentReview'] %}
        <button class="SelectMenu-item width-full"
                hx-post="/api/issues/{{ org }}/{{ item.repo }}/{{ item.number }}/unstick"
                hx-vals='{"target_stage": "{{ target }}"}'
                hx-headers='{"Content-Type": "application/json"}'
                hx-swap="none"
                hx-on::after-request="location.reload()">
          {{ target }}
        </button>
        {% endfor %}
      </div>
    </div>
  </div>
</details>
{% endmacro %}

{% set total = sections.stuck|length + sections.merge|length + sections.review|length + sections.approval|length %}

{% if total == 0 %}
<div class="blankslate">
  <h3 class="blankslate-heading">All clear</h3>
  <p>No issues need your attention right now.</p>
</div>
{% else %}

{% if sections.stuck %}
{{ section_header("Stuck", sections.stuck|length, "alert") }}
<div class="Box">
  {% for item in sections.stuck %}
  <div class="Box-row color-bg-danger-subtle d-flex flex-items-center flex-justify-between">
    <div>
      <a href="{{ item.github_url }}" target="_blank" class="Link--primary text-bold">
        {{ org }}/{{ item.repo }}#{{ item.number }}
      </a>
      <span class="Label Label--danger ml-2">agentStuck</span>
      <p class="color-fg-muted text-small mb-0 mt-1">{{ item.title }}</p>
    </div>
    <div class="d-flex" style="gap: 8px;">
      {{ unstick_form(item, org) }}
      <a href="{{ item.github_url }}" target="_blank" class="btn btn-sm">View on GitHub</a>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

{% if sections.merge %}
{{ section_header("Needs Merge", sections.merge|length, "git-merge") }}
<div class="Box">
  {% for item in sections.merge %}
  <div class="Box-row d-flex flex-items-center flex-justify-between">
    <div>
      <a href="{{ item.github_url }}" target="_blank" class="Link--primary text-bold">
        {{ org }}/{{ item.repo }}#{{ item.number }}
      </a>
      <span class="Label Label--done ml-2">agentMergeReady</span>
      <p class="color-fg-muted text-small mb-0 mt-1">{{ item.title }}</p>
    </div>
    <div class="d-flex" style="gap: 8px;">
      <a href="{{ item.github_url }}" target="_blank" class="btn btn-sm">View on GitHub</a>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

{% if sections.review %}
{{ section_header("Needs Review", sections.review|length, "eye") }}
<div class="Box">
  {% for item in sections.review %}
  <div class="Box-row d-flex flex-items-center flex-justify-between">
    <div>
      <a href="{{ item.github_url }}" target="_blank" class="Link--primary text-bold">
        {{ org }}/{{ item.repo }}#{{ item.number }}
      </a>
      <span class="Label Label--attention ml-2">agentReview</span>
      <p class="color-fg-muted text-small mb-0 mt-1">{{ item.title }}</p>
    </div>
    <div>
      <a href="{{ item.github_url }}" target="_blank" class="btn btn-sm">Review on GitHub</a>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

{% if sections.approval %}
{{ section_header("Needs Approval", sections.approval|length, "check-circle") }}
<div class="Box">
  {% for item in sections.approval %}
  <div class="Box-row d-flex flex-items-center flex-justify-between">
    <div>
      <a href="{{ item.github_url }}" target="_blank" class="Link--primary text-bold">
        {{ org }}/{{ item.repo }}#{{ item.number }}
      </a>
      <span class="Label Label--attention ml-2">{{ item.stage }}</span>
      <p class="color-fg-muted text-small mb-0 mt-1">{{ item.title }}</p>
    </div>
    <div class="d-flex" style="gap: 8px;">
      <button class="btn btn-sm btn-primary"
              hx-post="/api/issues/{{ org }}/{{ item.repo }}/{{ item.number }}/approve"
              hx-swap="none"
              hx-on::after-request="location.reload()">
        Approve
      </button>
      <a href="{{ item.github_url }}" target="_blank" class="btn btn-sm">View on GitHub</a>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

{% endif %}
